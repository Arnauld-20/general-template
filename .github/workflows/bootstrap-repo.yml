
name: Bootstrap New Repo from Template

on:
  workflow_dispatch:
    inputs:
      new_repo_name:
        description: "New repository name (e.g., devops-infra)"
        required: true
      visibility:
        description: "Visibility"
        type: choice
        options: [private, public]   # keep simple; 'internal' is org-only
        default: private

permissions:
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Verify PAT + template status
        env:
          PAT: ${{ secrets.REPO_CREATE_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO:  ${{ github.event.repository.name }}
        run: |
          set -e
          test -n "$PAT" || { echo "::error::Missing secret REPO_CREATE_TOKEN"; exit 1; }

          # Who am I (sanity)
          curl -fsS -H "Authorization: token $PAT" https://api.github.com/user | jq -r '.login' \
            || { echo "::error::PAT not valid. Ensure it is a *classic* PAT with repo scope."; exit 1; }

          # Check this repo is a template
          IS_TEMPLATE=$(curl -fsS -H "Authorization: token $PAT" \
            "https://api.github.com/repos/$OWNER/$REPO" | jq -r '.is_template')
          if [ "$IS_TEMPLATE" != "true" ]; then
            echo "::error::Enable 'Template repository' in Settings â†’ General for this repo."; exit 1;
          fi

      - name: Create new repo from this template (REST)
        id: create
        env:
          PAT: ${{ secrets.GH_TOKEN }}  
          GH_TOKEN: ${{ github.token }} 
          OWNER: ${{ github.repository_owner }}
          NAME:  ${{ inputs.new_repo_name }}
          VIS:   ${{ inputs.visibility }}
          TEMPLATE_FULL: ${{ github.repository }}  # owner/template
        run: |
          set -e

          # Map visibility -> private boolean
          if [ "$VIS" = "private" ]; then PRIV=true; else PRIV=false; fi

          API="https://api.github.com/repos/$TEMPLATE_FULL/generate"
          BODY=$(jq -n --arg owner "$OWNER" --arg name "$NAME" --argjson private $PRIV \
                  '{owner:$owner, name:$name, private:$private}')

          RESP=$(curl -fsS -X POST "$API" \
            -H "Authorization: token $PAT" \
            -H "Accept: application/vnd.github+json" \
            -d "$BODY")

          URL=$(echo "$RESP" | jq -r '.html_url // empty')
          if [ -z "$URL" ]; then
            echo "::group::API response"; echo "$RESP" | jq . || echo "$RESP"; echo "::endgroup::"
            echo "::error::Repo creation failed. Check PAT scopes and org policy."; exit 1;
          fi

          echo "url=$URL" >> "$GITHUB_OUTPUT"
          echo "### Created: $URL" >> "$GITHUB_STEP_SUMMARY"

      - name: Output link
        run: |
          echo "New repo: ${{ steps.create.outputs.url }}"
