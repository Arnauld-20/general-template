name: Terraform (Manual Apply)

on:
  workflow_dispatch:
    inputs:
      dir:
        description: "Terraform directory to apply (e.g., ./ or terraform)"
        required: true
        default: "."
      ref:
        description: "Git ref to apply (usually main)"
        required: true
        default: "main"

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

jobs:
  apply_manual:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Ensure required secrets exist
        run: |
          test -n "${{ secrets.AWS_ROLE_ARN }}" || { echo "::error::Missing AWS_ROLE_ARN"; exit 1; }
          test -n "${{ secrets.TF_BACKEND_BUCKET }}" || { echo "::error::Missing TF_BACKEND_BUCKET"; exit 1; }
          test -n "${{ secrets.TF_LOCK_TABLE }}" || { echo "::error::Missing TF_LOCK_TABLE"; exit 1; }

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Prep plugin cache
        run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

      - name: Sanity check path has .tf files
        shell: bash
        run: |
          set -euo pipefail
          d="${{ inputs.dir }}"
          [ -d "$d" ] || { echo "::error::Directory '$d' not found"; exit 1; }
          if ! find "$d" -maxdepth 1 -name '*.tf' -print -quit | grep -q .; then
            echo "::error::No *.tf files in '$d'"; exit 1
          fi

      - name: Init (with S3 backend)
        working-directory: ${{ inputs.dir }}
        run: |
          terraform init -input=false -upgrade -reconfigure \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="key=${{ github.repository }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}" \
            -backend-config="encrypt=true"

      - name: Validate
        working-directory: ${{ inputs.dir }}
        run: terraform validate

      - name: Plan
        working-directory: ${{ inputs.dir }}
        run: terraform plan -input=false -out=tfplan

      - name: Apply (manual)
        working-directory: ${{ inputs.dir }}
        run: terraform apply -input=false -auto-approve tfplan
