name: Terraform PR (Plan)

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, reopened, ready_for_review, synchronize ]

permissions:
  contents: read
  id-token: write   # OIDC -> AWS

env:
  AWS_REGION: us-east-1
  TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Ensure backend.hcl exists
        run: |
          test -f "${GITHUB_WORKSPACE}/backend.hcl" || { echo "::error::backend.hcl missing"; exit 1; }

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: Prep plugin cache
        run: mkdir -p "$TF_PLUGIN_CACHE_DIR"

      - name: Find Terraform directories (include repo root)
        id: find
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t DIRS < <(git ls-files -z '*.tf' \
            | xargs -0 -n1 dirname \
            | sed 's|^\./$|.|; s|^\./||' \
            | sort -u)
          echo "Found dirs:"; printf '%s\n' "${DIRS[@]}"
          if [ "${#DIRS[@]}" -eq 0 ]; then
            echo "dirs=[]" >> "$GITHUB_OUTPUT"
          else
            JSON=$(printf '%s\n' "${DIRS[@]}" | jq -R -s -c 'split("\n")[:-1]')
            echo "dirs=$JSON" >> "$GITHUB_OUTPUT"
          fi

      - name: Plan each directory
        if: steps.find.outputs.dirs != '[]'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          for d in $(echo '${{ steps.find.outputs.dirs }}' | jq -r '.[]'); do
            echo "=== Planning $d ==="
            pushd "$d" >/dev/null

            # Build a per-dir state key under owner/repo/
            if [ "$d" = "." ]; then
              KEY_SUFFIX="root/terraform.tfstate"
            else
              KEY_SUFFIX="$d/terraform.tfstate"
            fi
            KEY="${GITHUB_REPOSITORY}/${KEY_SUFFIX}"

            terraform init -input=false -upgrade -reconfigure \
              -backend-config="${GITHUB_WORKSPACE}/backend.hcl" \
              -backend-config="key=${KEY}"

            terraform validate

            set +e
            terraform plan -input=false -no-color -out=tfplan -detailed-exitcode
            code=$?
            terraform show -json tfplan > tfplan.json 2>/dev/null || true
            terraform show -no-color tfplan > tfplan.txt 2>/dev/null || true
            set -e
            popd >/dev/null

            safe=$(echo "$d" | tr '/' '-'); [ "$safe" = "." ] && safe="root"
            mkdir -p "artifacts/$safe"
            cp -f "$d/tfplan"      "artifacts/$safe/tfplan"      2>/dev/null || true
            cp -f "$d/tfplan.json" "artifacts/$safe/tfplan.json" 2>/dev/null || true
            cp -f "$d/tfplan.txt"  "artifacts/$safe/tfplan.txt"  2>/dev/null || true

            echo "## $d â€” exit code: $code (0=no changes, 2=changes)" >> $GITHUB_STEP_SUMMARY
            if [ -s "$d/tfplan.json" ]; then
              echo '' >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              jq -r '
                ( .resource_changes // [] )
                | map(.change.actions
                  | if . == ["create"] then "create"
                    elif . == ["update"] then "update"
                    elif . == ["delete"] then "delete"
                    elif . == ["delete","create"] or . == ["create","delete"] then "replace"
                    else "other" end)
                | reduce .[] as $a ({"create":0,"update":0,"delete":0,"replace":0,"other":0}; .[$a]+=1)
              ' "$d/tfplan.json" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi

            if [ $code -eq 1 ]; then
              echo "Plan failed in $d"; exit 1
            fi
          done

      - name: Upload plan artifacts
        if: steps.find.outputs.dirs != '[]'
        uses: actions/upload-artifact@v4
        with:
          name: tfplans-${{ github.run_id }}
          path: artifacts/**
